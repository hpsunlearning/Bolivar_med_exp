---
title: "Alpha Diversity"
date: "`r Sys.Date()`"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
library(knitr)
options(max.print="75")
opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, prompt=FALSE, tidy = TRUE, comment = NA, message = FALSE)
opts_knit$set(width=75)

# Loading library here
library(tidyverse)
library(ggpubr)
library(MASS)
library(segmented)
library(agricolae)
library(car)
library(effectsize)
library(rstatix)
library(patchwork)

# set path
source("assets/utils.R")

```
## Initial setup
**Setup color index**
```{r}
# Exposure level
Expo_color <- c("#1b9e77", "#d95f02", "#8da0cb")
names(Expo_color) <- c("Low", "Medium", "High")
print(Expo_color)
#plot(1:3, 1:3, col = Expo_color, pch = 16, cex = 4)
# Ethnicity
Ethnicity_color <- gg_color_hue(3)
names(Ethnicity_color) <- c("SANEMA", "YEKWANA", "Visitors")
print(Ethnicity_color)

Sanemas <- c("Chajuranha", "Mosenahanha", "Kuyuwininha", "Shianana-Jiyakwanha", "Washudihanha", "Sudukuma")
Yekwana <- c("Kanarakuni", "Fiyakwanha")
```

**Import the data**
```{r}
# Alpha diversities
alpha = readRDS("../data/alpha_imported_all.RDS")
```
```{r class.source='fold-show'}
# Mapping
## This mapping files include all villagers and baseline of visitors of all body sites
mt_ms = readRDS("../data/Mapping_MS_Expo.Rds")
Mapping_work <- mt_ms %>% mutate(Expo = ifelse(Ethnicity=="SANEMA", "Low", ifelse(Village=="Fiyakwanha", "Low", ifelse(SampleGroup=="Visitors", "High", "Medium"))) %>% factor(levels = c("Low", "Medium", "High")), Age_num = as.numeric(Age), Age_num = ifelse(is.na(Age_num), as.numeric(gsub(pattern = "_months", replacement = "", Age, ignore.case = T))/12, Age_num), Age_grp1 = ifelse(Age_num>=18, "Adults", "Children"))
Mapping_work$Age_num[Mapping_work$Age=="4_Days"] <- 0
Mapping_work$Age_num[Mapping_work$Age=="1_day"] <- 0
```

**Set up the Analysis**
```{r}
dat_alpha <- merge(alpha, Mapping_work, by = 1) %>% mutate(Age_grp2 = case_when(Age_num<=3 ~ "Age_0-3", Age_num<=8 ~ "Age_3-8", Age_num<18 ~ "Age_8-18", T ~ "Adults"))
```

## Effects of exposure level
```{r}
Indices <- colnames(alpha[c(2:5)])
Yrs <- c("2015", "2016")
BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand")
```
### Initial test on feces (no need to run)
**We first check the faith_pd which described the overall complexity of the microbial community.**
```{r, eval=FALSE}
BB = "Feces"
AA = "faith_pd"
# Year 2015
YY = "2015"
Work_dat <- dat_alpha %>% dplyr::filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers")

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Expo + Gender + Age_num:Expo + Age_num:Gender + Expo:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Expo + Gender + Age_num:Expo + Age_num:Gender + Expo:Gender)

anova(regforward.out)
```
The best model from 2015 includes Expo, Age, Expo:Age interaction and Gender (in decreasing importance).

```{r, eval=FALSE}
# Year 2016
YY = "2016"
Work_dat <- Work %>% dplyr::filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers")

# Obtain the full linear model
fit.full <- lm(get(AA) ~ Age_num + Expo + Gender + Age_num:Expo + Age_num:Gender + Expo:Gender, data = Work_dat)

# Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
fit.null <- lm(get(AA) ~ 1, data = Work_dat)

# Forward selection, scope parameters provides the full model
regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Expo + Gender + Age_num:Expo + Age_num:Gender + Expo:Gender)

anova(regforward.out)
```
The best model from 2016 includes Expo, Age, Expo:Age interaction (in decreasing importance), but Gender was not there.


So we will fitting the data with Expo, Age, Expo:Age interaction, and Gender for both years to keep unity.
```{r, eval=FALSE}
# Final model
lm_models <- list()
for (YY in Yrs){
  Work_dat <- Work %>% dplyr::filter(Body_Site==BB, Year==YY, SampleGroup=="Villagers")
  fit.final <- lm(as.formula(paste0(AA, " ~ Age_num + Expo + Age_num:Expo + Gender")), data = Work_dat)
  print(paste0("--------Below is ANOVA table for year ", YY))
  anova(fit.final) %>% print()
  
  print(paste0("--------Below is coefficient for year ", YY))
  summary(fit.final) %>% print()
  lm_models[[YY]] <- fit.final
}
```

Next we perform the broken stick regression based on the selected final model
```{r, eval=FALSE}
for (YY in Yrs){
  #YY = "2016"
  fit.seg <- segmented(lm_models[[YY]], seg.Z = ~ Age_num, psi = c(3))
  summary(fit.seg)
  plot(fit.seg$fitted.values, fit.seg$residuals)
  plot(fit.seg$model$faith_pd, fit.seg$fitted.values)
  plot(fit.seg$model$Age_num, hatvalues(fit.seg))
  plot(fit.seg$model$Age_num, cooks.distance(fit.seg))
  plot(hatvalues(fit.seg), fit.seg$residuals)
}
```

It seems from the residual plots that the point with faith_pd smaller than 10 is dragging the curve down and causing non-random residual. 

```{r, eval=FALSE}
Work %>% dplyr::filter(Body_Site==BB, faith_pd<12, SampleGroup=="Villagers")
```
It does appears that many baby are outliers, so re-do the analysis without baby.

### Modeling without babies
#### Overview
```{r}
for (bb in BodySites){
    for (aa in Indices){
        Work_dat <- dat_alpha %>% dplyr::filter(Body_Site==bb, SampleGroup=="Villagers", Age_num>=1)
        p <- ggplot(Work_dat, aes(x = Age_num, y = get(aa), color = Expo, shape = Gender)) +
            geom_point(size = 1.5) +
            scale_shape_manual(values = c(16, 21)) +
            scale_color_manual(breaks = names(Expo_color), values = Expo_color) +
            facet_grid(.~Year) +
            theme_jw() + theme(aspect.ratio = 0.8, panel.background = element_rect(color = "black")) +
            labs(x = "Age (Years)", y = aa, title = bb)
        print(p)
    }
}
```
#### Exploratory Statisticals
##### Children
Building full multiple linear regression models with interaction terms for children
```{r}
alpha_youngchild_lm_models = list()
lm.stats.tbl = list()
for (bb in BodySites){
    for (aa in Indices){
        for (yy in Yrs){
            Work_dat <- dat_alpha %>% dplyr::filter(Body_Site==bb, Year==yy, SampleGroup=="Villagers", Age_num>=1, Age_num<18)
            lm.model <- lm(paste0(aa, " ~ Age_num + Expo + Gender + Age_num:Expo + Age_num:Gender + Expo:Gender"), data = Work_dat, contrasts = list(Expo = "contr.sum", Gender = "contr.sum"))
            lm.stats = Anova(lm.model, type = 3) %>% # Type 3 ss
                merge(., effectsize::eta_squared(., ci = 0.95), by.x = 0, by.y = 1, all = T) %>% # effect size estimates
                rename(Factors = Row.names) %>% mutate(Year = yy, Body_Site = bb, Indice = aa)
            alpha_youngchild_lm_models[[bb]][[aa]][[yy]] = lm.model
            lm.stats.tbl[[paste(bb, aa, yy, sep = "-")]] = lm.stats
        }
    }
}
lm.stats.tbls = do.call("rbind", lm.stats.tbl) %>% rename(p_value = `Pr(>F)`) %>% mutate(q_value = p.adjust(p_value, method = "fdr"))

# full model (multiple linear regression) statistics for alpha diversity in children
#write.table(lm.stats.tbls, file = "../output/tables/alpha_lm_stats_children.txt", sep = "\t", row.names = F, quote = F)

lm.stats.tbls.2 = lm.stats.tbls %>% dplyr::filter(!is.na(Eta2_partial)) %>% mutate(Factors = factor(Factors, levels = c("Age_num", "Gender", "Expo", "Age_num:Expo", "Age_num:Gender", "Expo:Gender"))) %>% arrange(Body_Site, Indice, Year, Factors)

# p values    
ggplot(lm.stats.tbls.2, aes(x = Factors, y = q_value, color = Body_Site)) +
    geom_point() +
    geom_path(aes(group = Year, linetype = Year)) +
    facet_grid(Body_Site~Indice) +
    scale_y_continuous(breaks = c(0, 0.05, 0.1, 0.2, 1.0)) +
    theme_jw(base_size = 12) + theme(aspect.ratio = 0.4, axis.text.x = element_text(angle = 90, hjust = 1), panel.grid.minor = element_blank()) +
    ggtitle("FDR adjusted p-value for full models of alpha diversity in Children")

# eta partial
ggplot(lm.stats.tbls.2, aes(x = Factors, y = Eta2_partial, color = Body_Site)) +
    geom_point() +
    geom_path(aes(group = Year, linetype = Year)) +
    facet_grid(Body_Site~Indice, scales = "free_y") +
    #scale_y_continuous(breaks = c(0, 0.05, 0.1, 0.2, 1.0)) +
    theme_jw() + theme(aspect.ratio = 0.4, axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Effect size (eta partial) for full models of alpha diversity in Children")
```
No strong interactions obsereved among children

##### all ages
Building full multiple linear regression models with interaction terms
```{r}
alpha_full_lm_models = list()
lm.stats.tbl = list()
for (bb in BodySites){
    for (aa in Indices){
        for (yy in Yrs){
            Work_dat <- dat_alpha %>% dplyr::filter(Body_Site==bb, Year==yy, SampleGroup=="Villagers", Age_num>=1)
            lm.model <- lm(paste0(aa, " ~ Age_num + Expo + Gender + Age_num:Expo + Age_num:Gender + Expo:Gender"), data = Work_dat, contrasts = list(Expo = "contr.sum", Gender = "contr.sum"))
            lm.stats = Anova(lm.model, type = 3) %>% # Type 3 ss
                merge(., effectsize::eta_squared(., ci = 0.95), by.x = 0, by.y = 1, all = T) %>% # effect size estimates
                rename(Factors = Row.names) %>% mutate(Year = yy, Body_Site = bb, Indice = aa)
            alpha_full_lm_models[[bb]][[aa]][[yy]] = lm.model
            lm.stats.tbl[[paste(bb, aa, yy, sep = "-")]] = lm.stats
        }
    }
}
lm.stats.tbl = do.call("rbind", lm.stats.tbl)
#o full model (multiple linear regression) statistics for alpha diversity in all age
write.table(lm.stats.tbl, file = "../results/tables/alpha_lm_stats.txt", sep = "\t", row.names = F, quote = F)

lm.stats.tbl.2 = lm.stats.tbl %>% dplyr::filter(!is.na(Eta2_partial)) %>% rename(p_value = `Pr(>F)`) %>% mutate(Factors = factor(Factors, levels = c("Age_num", "Gender", "Expo", "Age_num:Expo", "Age_num:Gender", "Expo:Gender"))) %>% arrange(Body_Site, Indice, Year, Factors)
    
ggplot(lm.stats.tbl.2, aes(x = Factors, y = p_value, color = Body_Site)) +
    geom_point() +
    geom_path(aes(group = Year, linetype = Year)) +
    facet_grid(Body_Site~Indice) +
    scale_y_continuous(breaks = c(0, 0.05, 0.1, 0.2, 1.0)) +
    coord_cartesian(ylim = c(0, 0.2)) +
    theme_jw() + theme(aspect.ratio = 0.6, axis.text.x = element_text(angle = 90, hjust = 1)) +
    guides(color = F) +
    ggtitle("FDR adjusted p-value for full models of alpha diversity in all age")

ggplot(lm.stats.tbl.2, aes(x = Factors, y = Eta2_partial, color = Body_Site)) +
    geom_point() +
    geom_path(aes(group = Year, linetype = Year)) +
    facet_grid(Body_Site~Indice, scales = "free_y") +
    theme_jw() + theme(aspect.ratio = 0.6, axis.text.x = element_text(angle = 90, hjust = 1)) +
    guides(color = F) +
    ggtitle("Effect size (eta-partial) for full models of alpha diversity in all age")

#p1 + p2 + plot_layout(guides = "collect")
```

#### Final Models (No interaction terms)
```{r}
models = list()
model_tbls = data.frame(BodySite = as.character(),
                        Index = as.character(),
                        Year = as.character(),
                        Model = as.character(),
                        Model.type = as.character())

for (bb in BodySites){
    for (aa in Indices){
        for (yy in Yrs){
            Work_dat <- dat_alpha %>% dplyr::filter(Body_Site==bb, Year==yy, SampleGroup=="Villagers", Age_num>=1)
            # Obtain the full linear model
            fit.full <- lm(paste0(aa, " ~ Age_num + Expo + Gender"), data = Work_dat)
            # Obtain the null model with no predictors, this is necessary for forward selection use stepAIC
            fit.null <- lm(paste0(aa, " ~ 1"), data = Work_dat)
            
            # Forward selection, scope parameters provides the full model
            regforward.out <- stepAIC(fit.null, direction = "forward", trace = 4, scope = ~ Age_num + Expo + Gender)
            
            lm.model <- lm(regforward.out$terms, data = Work_dat, contrasts = list(Expo = "contr.sum", Gender = "contr.sum"))
            lm.model.anova = car::Anova(lm.model, type = 3)
            
            if ("Age_num" %in% rownames(lm.model.anova)){
                fit.seg <- segmented(regforward.out, seg.Z = ~ Age_num, psi = 9)
                model_comp = anova(fit.seg, lm.model)
                if (!is.na(model_comp[2, 6]) & model_comp[2, 6]<=0.05){
                    fit.final = fit.seg
                    # summary(fit.seg) %>% print()
                    fit.final$davies <- davies.test(lm.model, seg.Z = ~ Age_num, k = 10)
                    # confint.segmented(fit.seg) %>% print()
                    # slope(fit.seg) %>% print()
                } else {
                    fit.final = lm.model
                }
            } else {
                fit.final = lm.model
            }
            par(mfrow = c(2, 2))
            plot(fit.final$fitted.values, fit.final$residuals)
            plot((fit.final$model)[, 1], fit.final$fitted.values)
            plot(hatvalues(fit.final), fit.final$residuals)
            qqnorm(fit.final$residuals)
            ff = (fit.final$terms %>% as.character())[3]
            models[[bb]][[aa]][[yy]] = fit.final
            if ("segmented" %in% class(fit.final)){
                model_tbls = rbind(model_tbls, cbind(bb, aa, yy, ff, "segmented"))
            } else {
                model_tbls = rbind(model_tbls, cbind(bb, aa, yy, ff, "linear"))
            }
        }
    }
}

colnames(model_tbls) = c("Body_Site", "Indice", "Year", "Model", "Model.type")
model_tbls$Model <- gsub(" + psi1.Age_num", "", model_tbls$Model, fixed = T) %>% paste0(model_tbls$Indice, " ~ ", .)

fit_stats_final <- list()
for (bb in BodySites){
    for (aa in Indices){
        for (yy in Yrs){
            fit_ = models[[bb]][[aa]][[yy]]
            if(fit_$coefficients==1){
                next
            } 
            
            if("segmented" %in% class(fit_)){
                
            } else {
                fit_anova = models[[bb]][[aa]][[yy]] %>% Anova(., type = 3) 
                fit_omega = omega_squared(fit_anova, ci = 0.95) # effect size estimates
                fit_estimate = as.data.frame(summary(fit_)$Ttable)["Estimate"]
                fit_estimate$Factor = rownames(fit_anova)[sapply(rownames(fit_estimate), function(x){which(startsWith(x, rownames(fit_anova)))})]
                
                fit_stats = merge(fit_estimate, fit_anova, by.x = "Factor", by.y = 0, all.x = T) %>% merge(., fit_omega, by = 1, all.x = T) 
                fit_stats[which(fit_stats$Factor=="U1.Age_num"), ]$`Pr(>F)` = NA
                
            }
            fit_stats_final[[paste(bb, aa, yy, sep = "-")]] = fit_stats  %>% rename(p_value = `Pr(>F)`)
        }
    }
}
fit_stats_final.tbl = data.table::rbindlist(fit_stats_final, use.names = T, fill = T) %>% arrange(Body_Site, Indice, Year, Factors)
write.table(fit_stats_final.tbl, file = "../results/tables/alpha_fit_stats_final.txt", sep = "\t", row.names = F, quote = F)
```
#### Graphs
```{r}
Indices <- colnames(alpha[c(2:5)])
Yrs <- c("2015", "2016")
BodySites <- c("Feces", "Nose", "Mouth", "Right_Arm", "Right_Hand")

dat_new = complete(cbind(Age_num = seq(1, 60, 1), 
                         Expo = c("Low", "Medium"), 
                         Gender = c("F", "M")) %>% 
                       as.data.frame(), Age_num, Expo, Gender) %>% 
    mutate(Age_num = as.numeric(Age_num))

dat_pred = list()
for (bb in BodySites){
    for (aa in Indices){
        for(yy in Yrs){
            dat_pred[[bb]][[aa]][[yy]] = cbind(dat_new, predict(models[[bb]][[aa]][[yy]], newdata = dat_new, interval = "confidence"))
            
        }
    }
}
for (yy in Yrs){
    for (aa in Indices){
        #aa = "faith_pd"
        p_list = list()
        for (bb in BodySites){
            #bb = "Feces"
            dat_ = dat_alpha %>% dplyr::filter(Body_Site==bb, Year==yy, SampleGroup=="Villagers", Age_num>=1) %>% mutate(Expo = as.character(Expo))
            dat_pred_ = dat_pred[[bb]][[aa]][[yy]]
            mod = model_tbls %>% dplyr::filter(Body_Site==bb, Year==yy, Indice==aa) %>% pull(Model)
            p.expo = (models[[bb]][[aa]][[yy]] %>% car::Anova(type = "3") %>% as.data.frame())["Expo", "Pr(>F)"]
            p.expo = ifelse(p.expo<0.001, "P.Expo<0.001", paste0("P.Expo=", round(p.expo, 3)))
            p = ggplot(dat_, aes_string(x = "Age_num", y = aa, color = "Expo", shape = "Gender")) +
                geom_point(size = 1.5, alpha = 0.6) +
                geom_line(data = dat_pred_, aes(y = fit, linetype = Gender), size = 1) +
                geom_ribbon(data = dat_pred_, aes(y = fit, ymin = lwr, ymax = upr, fill = Expo, alpha = Gender), color = NA, show.legend = F) +
                annotate("label", x = Inf, y = Inf, label = paste(stringi::stri_wrap(c(mod, p.expo),width = 50), collapse = "\n"), hjust = 1, vjust = 1, size = 9/.pt) +
                scale_color_manual(values = Expo_color, limits = force) +
                scale_fill_manual(values = Expo_color, limits = force) +
                scale_shape_manual(values = c(16, 1)) +
                scale_linetype_manual(values = c(1, 2)) +
                scale_alpha_manual(values = c(0.4, 0.2)) +
                theme_jw(base_size = 14) + theme(aspect.ratio = 0.7, panel.background = element_rect(color = "black"), plot.title = element_text(hjust = 0, vjust = 1), plot.title.position = "panel", legend.key.width = unit(1,"cm"), legend.margin = margin(rep(-3, 4))) +
                labs(color = "Samples points", linetype = "Regression lines", shape = "", x = "Age (Years)") +
                guides(color = guide_legend(override.aes = list(alpha = 1, size = 1.5, linetype = c(NA, NA)), order = 1), shape = guide_legend(override.aes = list(size = 1.5, alpha = 1), order = 2), linetype = guide_legend(order = 3)) +
                ggtitle(bb)
            p_list[[bb]] = p
        }
        p_f = p_list[["Feces"]] + p_list[["Mouth"]] + guide_area() + p_list[["Nose"]] + p_list[["Right_Arm"]] + p_list[["Right_Hand"]] + plot_layout(guides = "collect", nrow = 2) + plot_annotation(title = yy, tag_levels = 'A') & theme(plot.tag = element_text(size = 10, face = "bold"))
        print(p_f)
        #set_panel_size(p = p_f, g = patchworkGrob(p_f), file = paste0( "../output/figures/alpha_regression_", aa, "_", yy, ".pdf"), width =  unit(3, "in"), height = unit(2.1, "in"))
    }
}
```

<!-- ## Effects of year -->

<!-- ```{r} -->
<!-- Indices <- colnames(alpha[c(2:5)]) -->
<!-- BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- for (bb in BodySites){ -->
<!--     for (aa in Indices){ -->
<!--         #break -->
<!--         dat_ = Work %>% dplyr::filter(Body_Site==bb, SampleGroup=="Villagers", Age_num>=1) %>% mutate(Year = as.character(Year), Age_grp2 = factor(Age_grp2, levels = c("Age_0-3", "Age_3-8", "Age_8-18", "Adults"))) -->

<!--         dat_.test = dat_ %>% group_by(Expo, Age_grp2) %>% wilcox_test(formula(paste0(aa, "~ Year"))) %>% add_xy_position(x = "Age_grp2", dodge = 0.7) %>% ungroup() %>% mutate(p.adj = p.adjust(p, method = "fdr") %>% round(digits = 3), p.adj.signif = ifelse(p.adj<=0.1, p.adj, "ns")) -->

<!--         ggplot(dat_, aes_string(x = "Age_grp2", y = aa, color = "Year")) + -->
<!--             geom_point(size = 0.75, position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.7)) + -->
<!--             geom_boxplot(aes(fill = Year), width = 0.5, color = "black", position = position_dodge(width = 0.7), size = 0.2, outlier.alpha = 0) + -->
<!--             stat_pvalue_manual(dat_.test, label = "p.adj", tip.length = 0, size = 8/.pt) + -->
<!--             facet_grid(.~Expo) + -->
<!--             theme_jw(base_size = 8) + theme(aspect.ratio = 0.8, legend.position = "top", legend.direction = "horizontal", panel.background = element_rect(color = "black"), plot.title = element_text(hjust = 0, vjust = 1), plot.title.position = "panel") + -->
<!--             scale_fill_manual(values = c(NA, NA)) + -->
<!--             scale_color_manual(values = c("#80b1d3", "#fb8072")) + -->
<!--             labs(x = "") + ggtitle(bb) -->
<!--         set_panel_size(p = last_plot(), file = paste0( "fig_tmp/alpha_compare_year_", aa, "_", bb, ".pdf"), width =  unit(3, "in"), height = unit(2.4, "in")) -->
<!--     } -->
<!-- } -->
<!-- ``` -->

<!-- ## Delta alpha diversity -->
<!-- ```{r} -->
<!-- Indices <- colnames(alpha[c(2:5)]) -->
<!-- BodySites <- c("Feces", "Mouth", "Nose", "Right_Arm", "Right_Hand") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- p_list = list() -->
<!-- for (bb in BodySites){ -->
<!--     for (aa in Indices){ -->
<!--         #break -->
<!--         dat_ = Work %>% dplyr::filter(Body_Site==bb, SampleGroup=="Villagers", Age_num>=1) %>% mutate(Year = as.character(Year), Age_grp2 = factor(Age_grp2, levels = c("Age_0-3", "Age_3-8", "Age_8-18", "Adults")), Expo = as.character(Expo)) -->
<!--         d_alpha = split(dat_, list(dat_$Year, dat_$Age_grp2, dat_$Expo)) %>% -->
<!--             lapply(., function(x){dist(x[[aa]], method = "manhattan") %>% as.numeric}) %>% do.call("c", .) %>% data.frame(delta_alpha = .) %>% rownames_to_column(var = "Tmp") %>% separate(Tmp, c("Year", "Age_grp2", "Expo"), sep = "\\.") %>% mutate(Expo = gsub("\\d+", "", Expo), Age_grp2 = factor(Age_grp2, levels = c("Age_0-3", "Age_3-8", "Age_8-18", "Adults"))) -->
<!--         d_alpha.test = d_alpha %>% group_by(Year, Age_grp2) %>% wilcox_test(delta_alpha ~ Expo) %>% add_xy_position(x = "Age_grp2", dodge = 0.7) %>% ungroup() %>% mutate(p.adj = p.adjust(p, method = "fdr") %>% round(digits = 3), p.adj.signif = ifelse(p.adj<=0.1, p.adj, "ns")) -->

<!--         p_list[[bb]][[aa]] <- ggplot(d_alpha, aes(x = Age_grp2, y = delta_alpha)) + -->
<!--             geom_quasirandom(size = 1.5, aes(fill = Expo), dodge.width = 0.7, shape = 21, alpha = 0.5) + -->
<!--             geom_boxplot(width = 0.5, aes(color = Expo), position = position_dodge(width = 0.7), fill = NA, size = 0.3, outlier.alpha = 0) + -->
<!--             stat_pvalue_manual(d_alpha.test, label = "p.adj", tip.length = 0, size = 8/.pt) + -->
<!--             facet_grid(.~Year) + -->
<!--             scale_fill_manual(values = Expo_color) + -->
<!--             scale_color_manual(values = c("black", "black")) + -->
<!--             theme_jw(base_size = 8) + theme(aspect.ratio = 0.8) + -->
<!--             labs(y = paste0("Absolute value \u0394(", aa, ")")) + ggtitle(bb) -->
<!--         print(p_list[[bb]][[aa]]) -->
<!--         set_panel_size(p = p_list[[bb]][[aa]], file = paste0("fig_tmp/delta_alpha_expo_", aa, "_", bb, ".pdf"), width = unit(3, "in"), height = unit(2.4, "in")) -->
<!--     } -->
<!-- } -->

<!-- p_list[["Feces"]][["faith_pd"]]+p_list[["Feces"]][["pielou_e"]] + plot_layout(guides = "collect", ncol = 1) -->

<!-- for (bb in BodySites){ -->
<!--     for (aa in Indices){ -->
<!--         #break -->
<!--         dat_ = Work %>% dplyr::filter(Body_Site==bb, SampleGroup=="Villagers", Age_num>=1) %>% mutate(Year = as.character(Year), Age_grp2 = factor(Age_grp2, levels = c("Age_0-3", "Age_3-8", "Age_8-18", "Adults")), Expo = as.character(Expo)) -->
<!--         d_alpha = split(dat_, list(dat_$Year, dat_$Age_grp2, dat_$Expo)) %>% -->
<!--             lapply(., function(x){dist(x[[aa]], method = "manhattan") %>% as.numeric}) %>% do.call("c", .) %>% data.frame(delta_alpha = .) %>% rownames_to_column(var = "Tmp") %>% separate(Tmp, c("Year", "Age_grp2", "Expo"), sep = "\\.") %>% mutate(Expo = gsub("\\d+", "", Expo), Age_grp2 = factor(Age_grp2, levels = c("Age_0-3", "Age_3-8", "Age_8-18", "Adults"))) -->
<!--         d_alpha.test = d_alpha %>% group_by(Expo, Age_grp2) %>% wilcox_test(delta_alpha ~ Year) %>% add_xy_position(x = "Age_grp2", dodge = 0.7) %>% ungroup() %>% mutate(p.adj = p.adjust(p, method = "fdr") %>% round(digits = 3), p.adj.signif = ifelse(p.adj<=0.1, p.adj, "ns")) -->

<!--         ggplot(d_alpha, aes(x = Age_grp2, y = delta_alpha)) + -->
<!--             geom_quasirandom(size = 1.5, aes(fill = Year), dodge.width = 0.7, shape = 21, alpha = 0.5) + -->
<!--             geom_boxplot(width = 0.5, aes(color = Year), position = position_dodge(width = 0.7), fill = NA, size = 0.3, outlier.alpha = 0) + -->
<!--             stat_pvalue_manual(d_alpha.test, label = "p.adj", tip.length = 0, size = 8/.pt) + -->
<!--             facet_grid(.~Expo) + -->
<!--             scale_fill_manual(values = c("#80b1d3", "#fb8072")) + -->
<!--             scale_color_manual(values = c("black", "black")) + -->
<!--             theme_jw(base_size = 8) + theme(aspect.ratio = 0.8) + -->
<!--             labs(y = paste0("Absolute value \u0394(", aa, ")")) + ggtitle(bb) -->
<!--         set_panel_size(file = paste0("fig_tmp/delta_alpha_year_", aa, "_", bb, ".pdf"), width = unit(3, "in"), height = unit(2.4, "in")) -->
<!--     } -->
<!-- } -->
<!-- ``` -->


